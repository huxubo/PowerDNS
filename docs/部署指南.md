# PowerDNS API 部署指南

## 目录

1. [系统要求](#系统要求)
2. [安装步骤](#安装步骤)
3. [配置指南](#配置指南)
4. [Web 服务器配置](#web-服务器配置)
5. [数据库优化](#数据库优化)
6. [安全加固](#安全加固)
7. [性能调优](#性能调优)
8. [监控和日志](#监控和日志)
9. [备份和恢复](#备份和恢复)
10. [常见问题](#常见问题)

## 系统要求

### 最低配置

- **操作系统**：Linux (Ubuntu 18.04+, CentOS 7+, Debian 9+)
- **PHP**：7.4 或更高版本
- **MySQL**：5.7 或更高版本（或 MariaDB 10.2+）
- **内存**：512MB RAM
- **磁盘**：1GB 可用空间
- **Web 服务器**：Apache 2.4+ 或 Nginx 1.14+

### 推荐配置

- **操作系统**：Ubuntu 20.04 LTS
- **PHP**：8.0+
- **MySQL**：8.0+
- **内存**：2GB RAM
- **磁盘**：10GB 可用空间
- **CPU**：2 核心

### PHP 扩展要求

```bash
# 必需扩展
php-pdo
php-pdo-mysql
php-json
php-mbstring

# 推荐扩展
php-opcache
php-apcu
```

## 安装步骤

### 1. 安装系统依赖

#### Ubuntu/Debian

```bash
# 更新系统
sudo apt update
sudo apt upgrade -y

# 安装 PHP 和扩展
sudo apt install -y php8.0 php8.0-fpm php8.0-mysql php8.0-json php8.0-mbstring php8.0-opcache

# 安装 MySQL
sudo apt install -y mysql-server

# 安装 Web 服务器（选择一个）
sudo apt install -y apache2  # Apache
# 或
sudo apt install -y nginx    # Nginx
```

#### CentOS/RHEL

```bash
# 更新系统
sudo yum update -y

# 安装 EPEL 和 Remi 仓库
sudo yum install -y epel-release
sudo yum install -y https://rpms.remirepo.net/enterprise/remi-release-7.rpm

# 启用 PHP 8.0
sudo yum-config-manager --enable remi-php80

# 安装 PHP 和扩展
sudo yum install -y php php-fpm php-mysqlnd php-json php-mbstring php-opcache

# 安装 MySQL
sudo yum install -y mysql-server

# 安装 Web 服务器
sudo yum install -y httpd  # Apache
```

### 2. 配置 MySQL

```bash
# 启动 MySQL
sudo systemctl start mysql
sudo systemctl enable mysql

# 安全配置
sudo mysql_secure_installation

# 登录 MySQL
sudo mysql -u root -p
```

### 3. 创建数据库和用户

```sql
-- 创建数据库
CREATE DATABASE powerdns CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci;

-- 创建用户
CREATE USER 'powerdns'@'localhost' IDENTIFIED BY 'your_secure_password_here';

-- 授予权限
GRANT ALL PRIVILEGES ON powerdns.* TO 'powerdns'@'localhost';

-- 刷新权限
FLUSH PRIVILEGES;

-- 退出
EXIT;
```

### 4. 导入数据库架构

```bash
# 下载项目
cd /var/www
sudo git clone https://github.com/yourusername/powerdns-api.git
cd powerdns-api

# 导入数据库
mysql -u powerdns -p powerdns < database/schema.sql
```

### 5. 配置 API

```bash
# 复制配置文件
sudo cp config/config.example.php config/config.php

# 编辑配置
sudo nano config/config.php
```

修改数据库连接信息：

```php
'database' => [
    'host' => 'localhost',
    'port' => 3306,
    'database' => 'powerdns',
    'username' => 'powerdns',
    'password' => 'your_secure_password_here',
    'charset' => 'utf8mb4',
],

'api' => [
    'key' => 'your-secure-api-key-here',  // 生成强密码
],
```

### 6. 设置权限

```bash
# 设置所有者
sudo chown -R www-data:www-data /var/www/powerdns-api

# 设置目录权限
sudo find /var/www/powerdns-api -type d -exec chmod 755 {} \;

# 设置文件权限
sudo find /var/www/powerdns-api -type f -exec chmod 644 {} \;

# 配置文件特殊权限（限制读取）
sudo chmod 600 /var/www/powerdns-api/config/config.php

# 创建日志目录
sudo mkdir -p /var/www/powerdns-api/logs
sudo chown www-data:www-data /var/www/powerdns-api/logs
sudo chmod 755 /var/www/powerdns-api/logs
```

## Web 服务器配置

### Apache 配置

#### 1. 启用必要的模块

```bash
sudo a2enmod rewrite
sudo a2enmod headers
sudo systemctl restart apache2
```

#### 2. 创建虚拟主机

```bash
sudo nano /etc/apache2/sites-available/powerdns-api.conf
```

```apache
<VirtualHost *:80>
    ServerName api.powerdns.local
    ServerAdmin admin@powerdns.local
    
    DocumentRoot /var/www/powerdns-api/public
    
    <Directory /var/www/powerdns-api/public>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>
    
    # 安全头
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-Frame-Options "DENY"
    Header always set X-XSS-Protection "1; mode=block"
    
    # 日志
    ErrorLog ${APACHE_LOG_DIR}/powerdns-api-error.log
    CustomLog ${APACHE_LOG_DIR}/powerdns-api-access.log combined
</VirtualHost>
```

#### 3. 启用站点

```bash
sudo a2ensite powerdns-api.conf
sudo systemctl restart apache2
```

### Nginx 配置

#### 1. 创建服务器块

```bash
sudo nano /etc/nginx/sites-available/powerdns-api
```

```nginx
server {
    listen 80;
    server_name api.powerdns.local;
    root /var/www/powerdns-api/public;
    index index.php;
    
    # 日志
    access_log /var/log/nginx/powerdns-api-access.log;
    error_log /var/log/nginx/powerdns-api-error.log;
    
    # 主要位置块
    location / {
        try_files $uri $uri/ /index.php?$query_string;
    }
    
    # PHP 处理
    location ~ \.php$ {
        fastcgi_pass unix:/var/run/php/php8.0-fpm.sock;
        fastcgi_index index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        
        # 超时设置
        fastcgi_read_timeout 300;
    }
    
    # 禁止访问隐藏文件
    location ~ /\. {
        deny all;
    }
    
    # 禁止访问配置文件
    location ~ /config/ {
        deny all;
    }
    
    # 安全头
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "DENY" always;
    add_header X-XSS-Protection "1; mode=block" always;
}
```

#### 2. 启用站点

```bash
sudo ln -s /etc/nginx/sites-available/powerdns-api /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl restart nginx
```

### HTTPS 配置（Let's Encrypt）

```bash
# 安装 Certbot
sudo apt install -y certbot python3-certbot-apache  # Apache
# 或
sudo apt install -y certbot python3-certbot-nginx   # Nginx

# 获取证书
sudo certbot --apache -d api.powerdns.local  # Apache
# 或
sudo certbot --nginx -d api.powerdns.local   # Nginx

# 自动续期
sudo certbot renew --dry-run
```

## 数据库优化

### 1. MySQL 配置调优

编辑 `/etc/mysql/mysql.conf.d/mysqld.cnf`：

```ini
[mysqld]
# 基本设置
max_connections = 200
max_allowed_packet = 64M

# InnoDB 设置
innodb_buffer_pool_size = 1G
innodb_log_file_size = 256M
innodb_flush_log_at_trx_commit = 2
innodb_flush_method = O_DIRECT

# 查询缓存
query_cache_type = 1
query_cache_size = 64M
query_cache_limit = 2M

# 临时表
tmp_table_size = 64M
max_heap_table_size = 64M

# 慢查询日志
slow_query_log = 1
slow_query_log_file = /var/log/mysql/slow.log
long_query_time = 2
```

重启 MySQL：

```bash
sudo systemctl restart mysql
```

### 2. 创建索引

```sql
USE powerdns;

-- 为常用查询添加索引
CREATE INDEX idx_records_name ON records(name);
CREATE INDEX idx_records_type ON records(type);
CREATE INDEX idx_records_content ON records(content(255));
CREATE INDEX idx_domains_name ON domains(name);

-- 复合索引
CREATE INDEX idx_records_domain_name_type ON records(domain_id, name, type);
```

### 3. 定期优化表

```bash
# 创建优化脚本
sudo nano /usr/local/bin/optimize-powerdns-db.sh
```

```bash
#!/bin/bash
mysql -u powerdns -p'your_password' powerdns << EOF
OPTIMIZE TABLE domains;
OPTIMIZE TABLE records;
OPTIMIZE TABLE cname_flatten_cache;
ANALYZE TABLE domains;
ANALYZE TABLE records;
EOF
```

```bash
# 设置执行权限
sudo chmod +x /usr/local/bin/optimize-powerdns-db.sh

# 添加到 crontab（每周执行）
sudo crontab -e
0 2 * * 0 /usr/local/bin/optimize-powerdns-db.sh
```

## 安全加固

### 1. 防火墙配置

```bash
# UFW (Ubuntu)
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 22/tcp
sudo ufw enable

# firewalld (CentOS)
sudo firewall-cmd --permanent --add-service=http
sudo firewall-cmd --permanent --add-service=https
sudo firewall-cmd --reload
```

### 2. IP 白名单

编辑 `config/config.php`：

```php
'security' => [
    'allowed_ips' => [
        '192.168.1.0/24',  // 内网
        '203.0.113.10',     // 管理员 IP
    ],
],
```

### 3. API Key 管理

```bash
# 生成强 API Key
openssl rand -hex 32

# 或使用 PHP
php -r "echo bin2hex(random_bytes(32)) . PHP_EOL;"
```

### 4. 文件权限加固

```bash
# 限制配置文件访问
sudo chmod 600 /var/www/powerdns-api/config/config.php
sudo chown root:www-data /var/www/powerdns-api/config/config.php

# 禁止 Web 访问敏感目录
# Apache
sudo nano /var/www/powerdns-api/.htaccess
```

```apache
<DirectoryMatch "^/.*/\.(git|config|database|docs)/">
    Require all denied
</DirectoryMatch>
```

### 5. Fail2Ban 配置

```bash
# 安装 Fail2Ban
sudo apt install -y fail2ban

# 创建过滤器
sudo nano /etc/fail2ban/filter.d/powerdns-api.conf
```

```ini
[Definition]
failregex = ^.*"error":"未授权".*"ip":"<HOST>".*$
ignoreregex =
```

```bash
# 创建监控规则
sudo nano /etc/fail2ban/jail.local
```

```ini
[powerdns-api]
enabled = true
port = http,https
filter = powerdns-api
logpath = /var/www/powerdns-api/logs/api.log
maxretry = 5
bantime = 3600
```

```bash
# 重启 Fail2Ban
sudo systemctl restart fail2ban
```

## 性能调优

### 1. PHP-FPM 优化

编辑 `/etc/php/8.0/fpm/pool.d/www.conf`：

```ini
[www]
pm = dynamic
pm.max_children = 50
pm.start_servers = 10
pm.min_spare_servers = 5
pm.max_spare_servers = 20
pm.max_requests = 500

; 性能设置
request_terminate_timeout = 300
request_slowlog_timeout = 10
slowlog = /var/log/php-fpm/slow.log
```

重启 PHP-FPM：

```bash
sudo systemctl restart php8.0-fpm
```

### 2. OPcache 配置

编辑 `/etc/php/8.0/mods-available/opcache.ini`：

```ini
opcache.enable=1
opcache.memory_consumption=256
opcache.interned_strings_buffer=16
opcache.max_accelerated_files=10000
opcache.revalidate_freq=60
opcache.fast_shutdown=1
```

### 3. APCu 缓存（可选）

```bash
# 安装 APCu
sudo apt install -y php8.0-apcu

# 配置
sudo nano /etc/php/8.0/mods-available/apcu.ini
```

```ini
apc.enabled=1
apc.shm_size=64M
apc.ttl=7200
apc.gc_ttl=3600
```

### 4. Nginx 缓存（如果使用 Nginx）

```nginx
# 在 http 块中添加
http {
    # 缓存配置
    proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=api_cache:10m max_size=100m inactive=60m;
    
    server {
        # ... 其他配置 ...
        
        # 缓存静态内容
        location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
            expires 7d;
            add_header Cache-Control "public, immutable";
        }
    }
}
```

## 监控和日志

### 1. 日志配置

编辑 `config/config.php`：

```php
'logging' => [
    'enabled' => true,
    'file' => '/var/www/powerdns-api/logs/api.log',
    'level' => 'info',  // debug, info, warning, error
],
```

### 2. 日志轮转

```bash
sudo nano /etc/logrotate.d/powerdns-api
```

```
/var/www/powerdns-api/logs/*.log {
    daily
    missingok
    rotate 14
    compress
    delaycompress
    notifempty
    create 0640 www-data www-data
    sharedscripts
    postrotate
        systemctl reload php8.0-fpm > /dev/null 2>&1 || true
    endscript
}
```

### 3. 监控脚本

```bash
# 创建监控脚本
sudo nano /usr/local/bin/monitor-powerdns-api.sh
```

```bash
#!/bin/bash

API_URL="http://localhost/api/v1/servers"
API_KEY="your-api-key"

# 检查 API 是否响应
response=$(curl -s -o /dev/null -w "%{http_code}" -H "X-API-Key: $API_KEY" $API_URL)

if [ "$response" != "200" ]; then
    echo "API 不可用，HTTP 状态码: $response"
    # 发送告警（可集成邮件、钉钉、微信等）
    # mail -s "PowerDNS API Alert" admin@example.com <<< "API down"
fi

# 检查数据库连接
mysql -u powerdns -p'your_password' -e "SELECT 1" > /dev/null 2>&1
if [ $? -ne 0 ]; then
    echo "数据库连接失败"
fi
```

### 4. Prometheus 监控（可选）

安装 PHP Prometheus 客户端并创建 metrics 端点。

## 备份和恢复

### 1. 数据库备份

```bash
# 创建备份脚本
sudo nano /usr/local/bin/backup-powerdns.sh
```

```bash
#!/bin/bash

BACKUP_DIR="/backup/powerdns"
DATE=$(date +%Y%m%d_%H%M%S)
MYSQL_USER="powerdns"
MYSQL_PASS="your_password"
MYSQL_DB="powerdns"

# 创建备份目录
mkdir -p $BACKUP_DIR

# 备份数据库
mysqldump -u $MYSQL_USER -p$MYSQL_PASS $MYSQL_DB | gzip > $BACKUP_DIR/powerdns_$DATE.sql.gz

# 删除 30 天前的备份
find $BACKUP_DIR -name "powerdns_*.sql.gz" -mtime +30 -delete

echo "备份完成: powerdns_$DATE.sql.gz"
```

```bash
# 设置执行权限
sudo chmod +x /usr/local/bin/backup-powerdns.sh

# 添加到 crontab（每天凌晨 2 点）
sudo crontab -e
0 2 * * * /usr/local/bin/backup-powerdns.sh
```

### 2. 配置文件备份

```bash
# 备份配置
sudo cp -r /var/www/powerdns-api/config /backup/powerdns-config-$(date +%Y%m%d)
```

### 3. 恢复数据库

```bash
# 解压备份
gunzip powerdns_20240101_020000.sql.gz

# 恢复数据库
mysql -u powerdns -p powerdns < powerdns_20240101_020000.sql
```

## 常见问题

### Q1: 500 Internal Server Error

**解决方法**：

```bash
# 检查 PHP 错误日志
sudo tail -f /var/log/php8.0-fpm/error.log

# 检查 Web 服务器错误日志
sudo tail -f /var/log/apache2/error.log  # Apache
sudo tail -f /var/log/nginx/error.log    # Nginx

# 检查文件权限
ls -la /var/www/powerdns-api
```

### Q2: 数据库连接失败

**解决方法**：

```bash
# 测试数据库连接
mysql -u powerdns -p -h localhost powerdns

# 检查 MySQL 状态
sudo systemctl status mysql

# 检查配置文件
cat /var/www/powerdns-api/config/config.php
```

### Q3: API Key 认证失败

**解决方法**：

```bash
# 检查 API Key
grep "api.*key" /var/www/powerdns-api/config/config.php

# 测试 API
curl -H "X-API-Key: your-api-key" http://localhost/api/v1/servers
```

### Q4: CNAME 展平不工作

**解决方法**：

```bash
# 检查配置
grep -A 5 "cname_flattening" /var/www/powerdns-api/config/config.php

# 检查日志
tail -f /var/www/powerdns-api/logs/api.log | grep CNAME

# 清除缓存
curl -X PUT -H "X-API-Key: your-api-key" \
  http://localhost/api/v1/servers/localhost/cache/flush
```

## 升级指南

```bash
# 1. 备份
sudo /usr/local/bin/backup-powerdns.sh

# 2. 拉取最新代码
cd /var/www/powerdns-api
sudo git pull

# 3. 检查数据库变更
# 如果有新的迁移文件，执行它们
mysql -u powerdns -p powerdns < database/migrations/xxx.sql

# 4. 重启服务
sudo systemctl restart php8.0-fpm
sudo systemctl restart apache2  # 或 nginx
```

## 总结

按照本指南，您应该能够成功部署和运行 PowerDNS API。记住：

1. ✅ 定期备份数据库
2. ✅ 监控日志和性能
3. ✅ 保持系统和依赖更新
4. ✅ 使用强 API Key
5. ✅ 启用 HTTPS
6. ✅ 配置防火墙和 IP 白名单
7. ✅ 定期检查安全更新

如有问题，请查看日志文件或提交 Issue。
